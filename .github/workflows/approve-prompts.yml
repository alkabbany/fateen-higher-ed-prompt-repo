name: Approve and Move Prompts

on:
  issue_comment:
    types: [created]

jobs:
  process_prompt:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Check for Approval
      if: github.event.comment.body == '✅ Approved'
      run: |
        PROMPT_ENTRY=$(awk 'BEGIN{RS="---"} /^### /' prompts/pending-approval.md | head -n 1)
        echo "Extracted Prompt: $PROMPT_ENTRY"

        DEPARTMENT=$(echo "$PROMPT_ENTRY" | awk '/\*\*Use Case\*\*: / {print $3; exit}')

        if [[ "$DEPARTMENT" == "Architectural Engineering" ]]; then
          TARGET_FILE="prompts/engineering-architectural.md"
        elif [[ "$DEPARTMENT" == "Computer Engineering" ]]; then
          TARGET_FILE="prompts/engineering-computer.md"
        elif [[ "$DEPARTMENT" == "Chemical and Petrochemical Engineering" ]]; then
          TARGET_FILE="prompts/engineering-chemical.md"
        elif [[ "$DEPARTMENT" == "Construction and Building Engineering" ]]; then
          TARGET_FILE="prompts/engineering-construction.md"
        elif [[ "$DEPARTMENT" == "Electronics and Communications Engineering" ]]; then
          TARGET_FILE="prompts/engineering-electronics.md"
        elif [[ "$DEPARTMENT" == "Electrical and Control Engineering" ]]; then
          TARGET_FILE="prompts/engineering-electrical.md"
        elif [[ "$DEPARTMENT" == "Industrial and Management Engineering" ]]; then
          TARGET_FILE="prompts/engineering-industrial.md"
        elif [[ "$DEPARTMENT" == "Marine and Offshore Engineering" ]]; then
          TARGET_FILE="prompts/engineering-marine.md"
        elif [[ "$DEPARTMENT" == "Mechanical Engineering" ]]; then
          TARGET_FILE="prompts/engineering-mechanical.md"
        elif [[ "$DEPARTMENT" == "Oil and Gas Engineering" ]]; then
          TARGET_FILE="prompts/engineering-oil.md"
        else
          TARGET_FILE="prompts/general.md"
        fi

        echo "$PROMPT_ENTRY" >> $TARGET_FILE
        sed -i "\|$PROMPT_ENTRY|,/^---/d" prompts/pending-approval.md

        git config --global user.name 'github-actions'
        git config --global user.email 'actions@github.com'
        git add prompts/*
        git commit -m "Approved prompt moved to $TARGET_FILE"
        git push

    - name: Check for Disapproval
      if: github.event.comment.body == '❌ Disapproved'
      run: |
        PROMPT_ENTRY=$(awk 'BEGIN{RS="---"} /^### /' prompts/pending-approval.md | head -n 1)
        echo "Disapproved Prompt: $PROMPT_ENTRY"

        sed -i "\|$PROMPT_ENTRY|,/^---/d" prompts/pending-approval.md

        git config --global user.name 'github-actions'
        git config --global user.email 'actions@github.com'
        git add prompts/*
        git commit -m "Disapproved prompt removed from pending-approval.md"
        git push
